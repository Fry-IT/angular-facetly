!function(){"use strict";angular.module("ngFacetly",["angular-lodash"])}(),function(){"use strict";var e={placeholder:"Search by...",listMaxItems:0};angular.module("ngFacetly").constant("DEFAULT_OPTIONS",e)}(),function(){"use strict";function e(e,t,n){return{restrict:"E",replace:!0,templateUrl:"angular-facetly.html",scope:{options:"=?",filteredBy:"=ngModel",appliedFilters:"=",unformattedFacets:"=facets",doSearch:"&?",doRemoveAll:"&?"},link:function(l){var i=function(e,t){return _.chain(e).filter(function(e){return!!("text"===e.type||"text"!==e.type&&_.isArray(e._options))&&_.findIndex(t,{id:e.id})===-1}).map(function(e){return{id:e.id,title:e.label}}).value()};l.options=_.assign({},n,l.options),l.facets=t.setFacets(l.unformattedFacets,function(e){var n=t.setFilter(l.filteredBy,e);_.isUndefined(n)||(l.addFilter(n),l.appliedFilters=t.updateAppliedFilters(l.filters))}),l.filters=[],l.typeaheadSuggestions=i(l.unformattedFacets,l.filters),l.addFilter=function(e){l.filters=t.addFilter(l.filters,e)},l.removeFilter=function(e){l.filters=t.removeFilter(l.filters,e),l.search()},l.removeAllFilters=function(){l.filters=t.removeAllFilters(),e(function(){l.doRemoveAll(),l.search()})},l.availableFacets=function(e){var t=l.filters||[];return e.isLoading!==!0&&_.findIndex(t,{id:e.id})===-1},l.addDefaultFilter=function(e){if(t.findFilterByKey(l.filters,"id",l.options.defaultFacet)===-1){var n=t.findFilterByKey(l.facets,"id",l.options.defaultFacet);n!==-1&&l.filters.push(_.assign({},l.facets[n],{value:e.title}))}},l.search=function(){l.query&&l.query.length&&l.addDefaultFilter({title:l.query});var n,s;n=t.updateModel(l.filters,l.facets,l.filteredBy),l.filters=t.validateValues(l.filters,n),s=!!_.isUndefined(_.find(l.filters,{isValid:!1})),l.errors=t.collectValidationErrors(l.filters),s&&"function"==typeof l.doSearch&&(l.filteredBy=n,l.appliedFilters=t.updateAppliedFilters(l.filters),e(function(){l.doSearch()}),l.typeaheadSuggestions=i(l.facets,l.filters))},l.addTypeaheadSuggestion=function(e){if(!_.isUndefined(e)){if(_.isUndefined(e.id))return l.addDefaultFilter(e),void l.search();var n=t.findFilterByKey(l.facets,"id",e.id);if(n!==-1){var s=angular.copy(l.facets[n]);l.filters=t.addFilter(l.filters,s),l.focusIndex=l.filters.indexOf(s),l.query="",l.typeaheadSuggestions=i(l.facets,l.filters)}}},l.$watch("facets",function(e,t){e!==t&&(l.typeaheadSuggestions=i(e,l.filters))},!0),l.$watch("filteredBy",function(e,n){l.showRemoveAll=!_.isEmpty(e),e!==n&&(l.focusIndex=-2,l.filters=t.setFilters(l.filteredBy,l.facets),l.appliedFilters=t.updateAppliedFilters(l.filters),l.typeaheadSuggestions=i(l.facets,l.filters))},!0)}}}e.$inject=["$timeout","FacetlyUtils","DEFAULT_OPTIONS"],angular.module("ngFacetly").directive("facetly",e)}(),function(){"use strict";function e(e,t){var n={};return n.setFilters=function(e,t){var l=[];return _.isObject(e)&&(l=_.chain(t).filter(function(t){return _.keys(e).indexOf(t.id)!==-1}).filter(function(e){return e.isLoading===!1}).map(function(t){return n.setFilter(e,t)}).value()),l},n.setFilter=function(e,t){if(_.has(e,t.id)&&void 0!==e[t.id]){if("select"===t.type||"hierarchy"===t.type){if(t.multiselect)return _.assign({},t,{value:_.map(e[t.id],function(e){var n=_.find(t._options,{id:e});return{id:e,title:n&&n.title||"n/a"}})});var n=_.find(t._options,{id:e[t.id]});return _.assign({},t,{value:{id:e[t.id],title:n&&n.title||"n/a"}})}return _.assign({},t,{value:e[t.id]})}},n.setFacets=function(e,n){return _.map(e,function(e){return e.isLoading=!0,e._options=[],t.when("function"==typeof e.options?e.options():e.options).then(function(t){e._options=t,e.isLoading=!1,_.isFunction(n)&&n(e)}),e})},n.findFilterByKey=function(e,t,n){return _.findIndex(e,function(e){return e[t]===n})},n.addFilter=function(e,t){var n=this.findFilterByKey(e,"id",t.id);return n===-1?e.concat([t]):e},n.removeFilter=function(e,t){var n=this.findFilterByKey(e,"id",t);return n!==-1?e.slice(0,n).concat(e.slice(n+1)):e},n.removeAllFilters=function(){return[]},n.getValues=function(e,t){return"select"!==t&&"hierarchy"!==t||(_.isArray(e)?e=_.map(e,function(e){return e.id}):_.isObject(e)&&(e=e.id)),e},n.updateModel=function(e,t,l){for(var i=0;i<t.length;i++){var s=_.find(e,{id:t[i].id});_.isUndefined(s)||_.isEmpty(s.value)?delete l[t[i].id]:l[s.id]=n.getValues(s.value,s.type)}return l},n.updateAppliedFilters=function(e){for(var t={},n=0;n<e.length;n++)_.isUndefined(e[n].value)||(t[e[n].label]=this.getValueForFilterByType(e[n]));return t},n.getValueForFilterByType=function(e){switch(e.type){case"select":return e.multiselect?_.map(e.value,function(e){return e.title}):e.value.title;case"hierarchy":return e.multiselect?_.map(e.value,function(e){return e.title}):e.value.title;default:return e.value}},n.flatten=function(e,t){return t=[]||t,_.forEach(e,function(e){t.push({id:e.id,title:e.title}),e.categories&&e.categories.length&&(t=t.concat(n.flatten(e.categories,t)))}),t},n.getFacetIds=function(e,t){return _.isArray(e)?e.map(function(e){return _.find(t,{title:e}).id}):_.find(t,{title:e}).id},n.validateValues=function(e,t){return _.map(e,function(e){return e=_.assign({},e),delete e.isValid,delete e.messages,e.validation&&e.validationMessages&&_.forEach(e.validation,function(n,l){"function"!=typeof n||_.isUndefined(e.validationMessages[l])||n(t[e.id])||(e.isValid=!1,e.messages=e.messages||[],e.messages.push(e.validationMessages[l]))}),e})},n.collectValidationErrors=function(e){return _.chain(e).filter(function(e){return e.messages&&e.messages.length}).map(function(e){var t=[];return _.forEach(e.messages,function(n){t.push(e.label+": "+n)}),t}).flatten().value()},n}e.$inject=["$log","$q"],angular.module("ngFacetly").service("FacetlyUtils",e)}(),function(){"use strict";function e(e){return{restrict:"E",replace:!0,templateUrl:"facets/hierarchy.html",scope:{options:"=",allowMultiselect:"=?",listMaxItems:"=?",onSelectChange:"&"},link:function(t){var n=e.flatten(t.options);t.allowMultiselect=!_.isUndefined(t.allowMultiselect)&&t.allowMultiselect,t.typeaheadSuggestions=_.map(n,function(e){return e.title}),t.addTypeaheadSuggestion=function(l){t.query=_.isArray(l)?"":l,t.onSelectChange({value:e.getFacetIds(l,n)})}}}}e.$inject=["FacetlyUtils"],angular.module("ngFacetly").directive("facetlyHierarchy",e)}(),function(){"use strict";function e(){return{restrict:"E",replace:!0,templateUrl:"facets/select.html",scope:{value:"=?",options:"=",allowMultiselect:"=?",listMaxItems:"=?",onSelectChange:"&"},link:function(e){e.allowMultiselect=!_.isUndefined(e.allowMultiselect)&&e.allowMultiselect,e.addTypeaheadSuggestion=function(t){e.onSelectChange({value:t})}}}}angular.module("ngFacetly").directive("facetlySelect",e)}(),function(){"use strict";function e(e){return{restrict:"E",replace:!0,templateUrl:"filter/filter.html",scope:{filter:"=",listMaxItems:"=?",onFilterRemove:"&",onDoSearch:"&",shouldFocus:"="},link:function(t,n,l){var i;switch(t.filter.type){case"select":i="input";break;default:i="input"}n.on("keydown",function(e){0!==t.filter.value&&13===e.which&&(e.preventDefault(),t.onDoSearch())}),t.$watch(function(){return t.shouldFocus},function(s){s===!0&&(e(function(){n.find(i)[0].focus()}),t[l.shouldFocus]=!1)}),t.updateFilterValue=function(n){t.filter.value=n,e(function(){t.onDoSearch()})},t.remove=function(){t.onFilterRemove({id:t.filter.id})},t.$on("$destroy",function(){n.off("keydown")})}}}e.$inject=["$timeout"],angular.module("ngFacetly").directive("facetlyFilter",e)}(),function(){"use strict";function e(e,t,n){function l(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}function i(e){return/<.*>/g.test(e)}var s;s=t.has("$sanitize");var a=function(t,a){return!s&&i(t)&&n.warn("Unsafe use of typeahead please use ngSanitize"),t=a?(""+t).replace(new RegExp(l(a),"gi"),"<strong>$&</strong>"):t,s||(t=e.trustAsHtml(t)),t};return a}e.$inject=["$sce","$injector","$log"],angular.module("ngFacetly").filter("facetlyHighlight",e)}(),function(){"use strict";function e(e,t){return{restrict:"E",replace:!0,templateUrl:"typeahead/typeahead.html",scope:{query:"=",value:"=?",facets:"=",placeholder:"@?",allowMultiselect:"=?",doNotForceOptions:"@?",resetOnSelect:"@?",hideNotFound:"=?",listMaxItems:"=?",onSelect:"&"},link:function(n,l){var i=n.listMaxItems||50,s=[13,38,40,32,27,9],a=function(e){_.isUndefined(e)&&n.doNotForceOptions?n.onSelect({value:{title:n.query}}):n.onSelect({value:e}),n.allowMultiselect||(n.showSuggestions=!1),n.resetOnSelect?n.query="":_.isUndefined(e)||(n.query=_.isArray(e)?"":e.title)},c=function(e){var t=_.find(n.selected,{id:e.id});_.isUndefined(t)?n.selected=n.selected.concat([e]):n.selected=_.without(n.selected,e)},r=function(e,t){return _.chain(t).filter(function(t){if(0===e.length)return!0;try{return t.title.toLowerCase().indexOf(e.toLowerCase())!==-1}catch(n){return!1}}).value()},o=function(t){var n=l.find("ul").children("li")[t];e(function(){l.find("ul")[0].scrollTop=n.offsetTop-n.offsetHeight})},u=function(e){_.isArray(e)&&e.length>0&&(n.selected=e,n.query="",n.showSelected=!0)};n.suggestions=[],n.selectedIndex=-1,n.allowMultiselect&&(n.selected=[]),n.showSuggestions=!1,n.addSuggested=function(e){n.allowMultiselect?(c(e),a(n.selected),u(n.selected)):a(e)},n.updateSelectedIndex=function(e){n.selectedIndex=_.findIndex(n.suggestions,{id:e.id})},n.removeSelected=function(e){n.selected=_.without(n.selected,e),a(n.selected)},n.isSelected=function(e){return _.findIndex(n.selected,{id:e.id})!==-1},l.on("keydown",function(e){if(0===n.suggestions.length||s.indexOf(e.which)===-1)return void(n.query&&n.query.length>0&&13===e.which&&(a(),n.$apply()));switch(e.which){case 38:n.selectedIndex>0&&(n.selectedIndex--,o(n.selectedIndex));break;case 40:n.selectedIndex<n.suggestions.length-1&&(n.selectedIndex++,o(n.selectedIndex));break;case 32:n.allowMultiselect&&n.addSuggested(n.suggestions[n.selectedIndex]);break;case 27:n.showSuggestions=!1;break;case 9:n.allowMultiselect&&n.selected&&(a(n.selected),u(n.selected),n.showSuggestions=!1);break;default:13===e.which&&(n.allowMultiselect&&n.selected.length>0?(u(n.selected),a(n.selected)):!n.allowMultiselect&&n.selectedIndex>-1&&a(n.suggestions[n.selectedIndex]))}n.$apply()}),n.$watch("query",function(e,t){e===t&&""!==e||(n.facets.length>1e3&&e.length>=5||n.facets.length>500&&n.facets.length<1e3&&e.length>=3||n.facets.length>100&&n.facets.length<500&&e.length>=2||n.facets.length<=100&&e.length>-1?(n.selectedIndex=-1,n.suggestions=r(e,n.facets),u(e)):n.suggestions=[])}),n.$watch("facets",function(e){e.length<=i&&(n.suggestions=e.slice())}),n.$watch("value",function(e){_.isUndefined(e)?n.selected=[]:_.isArray(e)?(n.selected=[],_.forEach(e,function(e){c(e),a(n.selected),n.showSelected=!0})):a(n.value)},!0),e(function(){t.on("click",function(e){3!==e.which&&l.find("input")[0]!==e.target&&(n.showSuggestions=!1,n.$apply())})}),n.$on("$destroy",function(){l.off("keydown")})}}}e.$inject=["$timeout","$document"],angular.module("ngFacetly").directive("facetlyTypeahead",e)}(),angular.module("ngFacetly").run(["$templateCache",function(e){e.put("angular-facetly.html",'<div class="facetly">\n  <div class="facetly-search">\n    <div class="facetly-searchbox">\n      <ul class="facetly-filters">\n        <facetly-filter\n          ng-repeat="filter in filters"\n          filter="filter"\n          list-max-items="options.listMaxItems"\n          on-filter-remove="removeFilter(id)"\n          on-do-search="search()"\n          should-focus="filters.indexOf(filter) === focusIndex" />\n      </ul>\n\n      <facetly-typeahead\n        ng-show="filters.length !== facets.length"\n        query="query"\n        facets="typeaheadSuggestions"\n        hide-not-found="options.defaultFacet && !filters.length"\n        reset-on-select="true"\n        do-not-force-options="true"\n        on-select="addTypeaheadSuggestion(value)"\n        placeholder="{{options.placeholder}}" />\n    </div>\n\n    <div class="facetly-buttons">\n      <a href="" class="facetly-button facetly-button-success" ng-click="search()">Search</a>\n      <a class="facetly-button facetly-button-danger" href="" ng-if="showRemoveAll" ng-click="removeAllFilters()">Clear</a>\n    </div>\n  </div>\n\n  <p class="facetly-hint-text facetly-text-danger" ng-show="errors.length">\n    Please correct the following errors before continuing:\n    <ul>\n      <li ng-repeat="error in errors" ng-bind="error"></li>\n    </ul>\n  </p>\n\n  <ul class="facetly-facets" ng-show="showFacets">\n    <li ng-repeat="facet in facets | filter:availableFacets">\n      <a class="facetly-facet" href="" title="" ng-click="addFilter(facet)" ng-bind="facet.label"></a>\n    </li>\n  </ul>\n</div>\n'),e.put("facets/hierarchy.html",'<div class="facetly-hierarchy">\n\n  <facetly-typeahead\n    allow-multiselect="allowMultiselect"\n    query="query"\n    facets="typeaheadSuggestions"\n    on-select="addTypeaheadSuggestion(value)"\n    list-max-items="listMaxItems"\n    placeholder="Start typing to filter..." />\n\n</div>\n'),e.put("facets/select.html",'<div class="facetly-select">\n\n  <facetly-typeahead\n    allow-multiselect="allowMultiselect"\n    query="query"\n    value="value"\n    facets="options"\n    on-select="addTypeaheadSuggestion(value)"\n    list-max-items="listMaxItems"\n    placeholder="Start typing to filter..." />\n\n</div>\n'),e.put("filter/filter.html",'<li ng-class="{\'facetly-validation-error\': filter.isValid === false}">\n  <span class="facetly-facet">\n    <a class="facetly-icon facetly-text-danger" href="" tabindex="-1" ng-click="remove()"> &times; </a>\n    {{::filter.label}}:\n  </span>\n  <span class="facetly-value" ng-switch="filter.type">\n    <facetly-select ng-switch-when="select" options="filter._options" allow-multiselect="filter.multiselect" on-select-change="updateFilterValue(value)" list-max-items="listMaxItems" value="filter.value" />\n    <facetly-hierarchy ng-switch-when="hierarchy" options="filter._options" allow-multiselect="filter.multiselect" on-select-change="updateFilterValue(value)" list-max-items="listMaxItems" value="filter.value" />\n    <input ng-switch-default type="text" class="facetly-form-control" ng-model="filter.value" />\n  </span>\n</li>\n'),e.put("typeahead/typeahead.html",'<div class="facetly-typeahead">\n  <div class="facetly-typeahead-selected" ng-show="showSelected">\n    <span ng-repeat="value in selected">\n      <a class="facetly-icon facetly-text-danger" href="" tabindex="-1" ng-click="removeSelected(value)">&times;</a> {{value.title}}\n    </span>\n  </div>\n\n  <input\n    class="facetly-form-control"\n    type="text"\n    ng-model="query"\n    ng-focus="showSuggestions=true"\n    placeholder="{{placeholder}}">\n\n  <div class="facetly-typeahead-suggestions" ng-if="showSuggestions && suggestions.length > 0">\n    <ul>\n      <li class="facetly-suggestion"\n        ng-class="{\'last\': $last, \'selected\': $index === selectedIndex}"\n        ng-repeat="suggestion in suggestions track by $index"\n        ng-mouseenter="updateSelectedIndex(suggestion)">\n          <a href="" ng-click="addSuggested(suggestion)">\n            <span ng-if="allowMultiselect && isSelected(suggestion)">&#10004;</span>\n            <span ng-bind-html="suggestion.title | facetlyHighlight:query"></span>\n          </a>\n      </li>\n      <li class="last" ng-show="query.length && !suggestions.length && !hideNotFound">\n        <span>No match found...</span>\n      </li>\n    </ul>\n  </div>\n</div>\n')}]);