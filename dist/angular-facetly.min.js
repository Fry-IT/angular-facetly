!function(){"use strict";angular.module("ngFacetly",["angular-lodash"])}(),function(){"use strict";var e={placeholder:"Search by...",listMaxItems:0};angular.module("ngFacetly").constant("DEFAULT_OPTIONS",e)}(),function(){"use strict";function e(e,t,n){return{restrict:"E",replace:!0,templateUrl:"angular-facetly.html",scope:{options:"=?",filteredBy:"=ngModel",appliedFilters:"=",unformattedFacets:"=facets",doSearch:"&?"},link:function(l){var i=function(e,t){return _.chain(e).filter(function(e){return!!("text"===e.type||"text"!==e.type&&_.isArray(e.options))&&_.findIndex(t,{id:e.id})===-1}).map(function(e){return{id:e.id,title:e.label}}).value()};l.options=_.assign({},n,l.options),l.facets=t.setFacets(l.unformattedFacets),l.filters=t.setFilters(l.filteredBy,l.facets),l.typeaheadSuggestions=i(l.unformattedFacets,l.filters),l.addFilter=function(e){l.filters=t.addFilter(l.filters,e)},l.removeFilter=function(e){l.filters=t.removeFilter(l.filters,e)},l.removeAllFilters=function(){l.filters=t.removeAllFilters(),"function"==typeof l.doSearch&&(l.filteredBy=t.updateModel(l.filters),l.doSearch())},l.availableFacets=function(e){var t=l.filters||[];return e.isLoading!==!0&&_.findIndex(t,{id:e.id})===-1},l.search=function(){if(0===l.filters.length&&l.options.defaultFacet.length&&l.query.length){var n=t.findFilterByKey(l.facets,"id",l.options.defaultFacet);n!==-1&&(l.filters=[_.assign({},l.facets[n],{value:l.query})])}l.query="";var s,a;s=t.updateModel(l.filters),l.filters=t.validateValues(l.filters,s),a=!!_.isUndefined(_.find(l.filters,{isValid:!1})),l.errors=t.collectValidationErrors(l.filters),a&&"function"==typeof l.doSearch&&(l.filteredBy=s,l.appliedFilters=t.updateAppliedFilters(l.filters),e(function(){l.doSearch()}),l.typeaheadSuggestions=i(l.facets,l.filters))},l.addTypeaheadSuggestion=function(e){var n=t.findFilterByKey(l.facets,"id",e.id);n!==-1&&(l.filters=t.addFilter(l.filters,l.facets[n]),l.focusIndex=l.filters.indexOf(l.facets[n]),l.query="",l.typeaheadSuggestions=i(l.facets,l.filters))},l.$watch("facets",function(e,t){e!==t&&(l.typeaheadSuggestions=i(e,l.filters))},!0),l.$watch("filteredBy",function(e,n){e!==n&&(l.filters=t.setFilters(l.filteredBy,l.facets))},!0)}}}e.$inject=["$timeout","FacetlyUtils","DEFAULT_OPTIONS"],angular.module("ngFacetly").directive("facetly",e)}(),function(){"use strict";function e(e,t){var n={};return n.setFilters=function(e,t){var n=[];return _.isObject(e)&&(n=_.chain(t).filter(function(t){return _.keys(e).indexOf(t.id)!==-1}).map(function(t){return"select"===t.type||"hierarchy"===t.type?t.multiselect?_.assign({},t,{value:_.map(e[t.id],function(e){return{id:e,title:_.find(t.options,{id:e}).title}})}):_.assign({},t,{value:{id:e[t.id],title:_.find(t.options,{id:e[t.id]}).title}}):_.assign({},t,{value:e[t.id]})}).value()),n},n.setFacets=function(e){return _.map(e,function(e){return e=_.assign({},e),e.isLoading=!0,t.when("function"==typeof e.options?e.options():e.options).then(function(t){e.options=t,e.isLoading=!1}),e})},n.findFilterByKey=function(e,t,n){return _.findIndex(e,function(e){return e[t]===n})},n.addFilter=function(e,t){var n=this.findFilterByKey(e,"id",t.id);return n===-1?e.concat([t]):e},n.removeFilter=function(e,t){var n=this.findFilterByKey(e,"id",t);return n!==-1?e.slice(0,n).concat(e.slice(n+1)):e},n.removeAllFilters=function(){return[]},n.getValues=function(e,t){return"select"!==t&&"hierarchy"!==t||(_.isArray(e)?e=_.map(e,function(e){return e.id}):_.isObject(e)&&(e=e.id)),e},n.updateModel=function(e){for(var t={},l=0;l<e.length;l++)_.isUndefined(e[l].value)||(t[e[l].id]=n.getValues(e[l].value,e[l].type));return t},n.updateAppliedFilters=function(e){for(var t={},n=0;n<e.length;n++)_.isUndefined(e[n].value)||(t[e[n].label]=this.getValueForFilterByType(e[n]));return t},n.getValueForFilterByType=function(e){switch(e.type){case"select":return e.multiselect?_.map(e.value,function(e){return e.title}):e.value.title;case"hierarchy":return e.multiselect?_.map(e.value,function(e){return e.title}):e.value.title;default:return e.value}},n.flatten=function(e,t){return t=[]||t,_.forEach(e,function(e){t.push({id:e.id,title:e.title}),e.categories&&e.categories.length&&(t=t.concat(n.flatten(e.categories,t)))}),t},n.getFacetIds=function(e,t){return _.isArray(e)?e.map(function(e){return _.find(t,{title:e}).id}):_.find(t,{title:e}).id},n.validateValues=function(e,t){return _.map(e,function(e){return e=_.assign({},e),delete e.isValid,delete e.messages,e.validation&&e.validationMessages&&_.forEach(e.validation,function(n,l){"function"!=typeof n||_.isUndefined(e.validationMessages[l])||n(t[e.id])||(e.isValid=!1,e.messages=e.messages||[],e.messages.push(e.validationMessages[l]))}),e})},n.collectValidationErrors=function(e){return _.chain(e).filter(function(e){return e.messages&&e.messages.length}).map(function(e){var t=[];return _.forEach(e.messages,function(n){t.push(e.label+": "+n)}),t}).flatten().value()},n}e.$inject=["$log","$q"],angular.module("ngFacetly").service("FacetlyUtils",e)}(),function(){"use strict";function e(e){return{restrict:"E",replace:!0,templateUrl:"facets/hierarchy.html",scope:{options:"=",allowMultiselect:"=?",listMaxItems:"=?",onSelectChange:"&"},link:function(t){var n=e.flatten(t.options);t.allowMultiselect=!_.isUndefined(t.allowMultiselect)&&t.allowMultiselect,t.typeaheadSuggestions=_.map(n,function(e){return e.title}),t.addTypeaheadSuggestion=function(l){t.query=_.isArray(l)?"":l,t.onSelectChange({value:e.getFacetIds(l,n)})}}}}e.$inject=["FacetlyUtils"],angular.module("ngFacetly").directive("facetlyHierarchy",e)}(),function(){"use strict";function e(e){return{restrict:"E",replace:!0,templateUrl:"facets/select.html",scope:{value:"=?",options:"=",allowMultiselect:"=?",listMaxItems:"=?",onSelectChange:"&"},link:function(e){e.allowMultiselect=!_.isUndefined(e.allowMultiselect)&&e.allowMultiselect,e.typeaheadSuggestions=_.map(e.options,function(e){return e.title}),e.addTypeaheadSuggestion=function(t){e.onSelectChange({value:t})}}}}e.$inject=["FacetlyUtils"],angular.module("ngFacetly").directive("facetlySelect",e)}(),function(){"use strict";function e(){return{restrict:"E",replace:!0,templateUrl:"filter/filter.html",scope:{filter:"=",listMaxItems:"=?",onFilterRemove:"&",onDoSearch:"&"},link:function(e,t,n){var l;switch(e.filter.type){case"select":l="input";break;default:l="input"}t.on("keydown",function(t){0!==e.filter.value&&13===t.which&&(t.preventDefault(),e.onDoSearch(),e.$apply())}),e.$watch(n.shouldFocus,function(i,s){i===!0&&(t.find(l)[0].focus(),e[n.shouldFocus]=!1)}),e.updateFilterValue=function(t){e.filter.value=t},e.remove=function(){e.onFilterRemove({id:e.filter.id})},e.$on("$destroy",function(){t.off("keydown")})}}}angular.module("ngFacetly").directive("facetlyFilter",e)}(),function(){"use strict";function e(e,t,n){function l(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}function i(e){return/<.*>/g.test(e)}var s;s=t.has("$sanitize");var a=function(t,a){return!s&&i(t)&&n.warn("Unsafe use of typeahead please use ngSanitize"),t=a?(""+t).replace(new RegExp(l(a),"gi"),"<strong>$&</strong>"):t,s||(t=e.trustAsHtml(t)),t};return a}e.$inject=["$sce","$injector","$log"],angular.module("ngFacetly").filter("facetlyHighlight",e)}(),function(){"use strict";function e(e,t){return{restrict:"E",replace:!0,templateUrl:"typeahead/typeahead.html",scope:{query:"=",value:"=?",facets:"=",placeholder:"@?",allowMultiselect:"=?",hideNotFound:"=?",listMaxItems:"=?",onSelect:"&"},link:function(n,l){var i=[13,38,40,32,27,9],s=function(e){n.onSelect({value:e}),n.allowMultiselect||(n.showSuggestions=!1),n.query=_.isArray(e)?"":e.title},a=function(e){var t=_.find(n.selected,{id:e.id});_.isUndefined(t)?n.selected=n.selected.concat([e]):n.selected=_.without(n.selected,e)},c=function(e,t){return _.chain(t).filter(function(t){return 0===e.length||t.title.toLowerCase().indexOf(e.toLowerCase())!==-1}).value()},r=function(t){var n=l.find("ul").children("li")[t];e(function(){l.find("ul")[0].scrollTop=n.offsetTop-n.offsetHeight})},o=function(e){_.isArray(e)&&e.length>0&&(n.selected=e,n.query="",n.showSelected=!0)};n.suggestions=[],n.selectedIndex=-1,n.allowMultiselect&&(n.selected=[]),n.showSuggestions=!1,n.addSuggested=function(e){n.allowMultiselect?(a(e),s(n.selected),o(n.selected)):s(e)},n.updateSelectedIndex=function(e){n.selectedIndex=_.findIndex(n.suggestions,{id:e.id})},n.removeSelected=function(e){n.selected=_.without(n.selected,e),s(n.selected)},n.isSelected=function(e){return _.findIndex(n.selected,{id:e.id})!==-1},l.on("keydown",function(e){if(0!==n.suggestions.length&&i.indexOf(e.which)!==-1){switch(e.which){case 38:n.selectedIndex>0&&(n.selectedIndex--,r(n.selectedIndex));break;case 40:n.selectedIndex<n.suggestions.length-1&&(n.selectedIndex++,r(n.selectedIndex));break;case 32:n.allowMultiselect&&a(n.suggestions[n.selectedIndex]);break;case 27:n.showSuggestions=!1;break;case 9:n.allowMultiselect&&(s(n.selected),o(n.selected),n.showSuggestions=!1);break;default:13===e.which&&(n.allowMultiselect&&n.selected.length>0?(o(n.selected),s(n.selected)):!n.allowMultiselect&&n.selectedIndex>-1&&s(n.suggestions[n.selectedIndex]))}n.$apply()}}),n.$watch("query",function(e,t){e===t&&""!==e||(n.suggestions.length>1e3&&e.length>5||n.suggestions.length>500&&e.length>3||n.suggestions.length>100&&e.length>2||n.suggestions.length<=100&&e.length>-1)&&(n.selectedIndex=-1,n.suggestions=c(e,n.facets),o(e))}),n.$watch("facets",function(e){n.suggestions=e.slice()}),n.$watch("value",function(e,t){_.isUndefined(e)||(n.suggestions=n.facets.slice(),_.isArray(e)?(n.selected=[],_.forEach(e,function(e){a(e),s(n.selected),n.showSelected=!0})):s(n.value))},!0),t.on("click",function(e){3!==e.which&&l.find("input")[0]!==e.target&&n.$apply(function(){n.showSuggestions=!1})}),n.$on("$destroy",function(){l.off("keydown")})}}}e.$inject=["$timeout","$document"],angular.module("ngFacetly").directive("facetlyTypeahead",e)}(),angular.module("ngFacetly").run(["$templateCache",function(e){e.put("angular-facetly.html",'<div class="facetly">\n  <div class="facetly-search">\n    <div class="facetly-searchbox">\n      <ul class="facetly-filters">\n        <facetly-filter\n          ng-repeat="filter in filters"\n          filter="filter"\n          list-max-items="options.listMaxItems"\n          on-filter-remove="removeFilter(id)"\n          on-do-search="search()"\n          should-focus="filters.indexOf(filter) === focusIndex" />\n      </ul>\n\n      <facetly-typeahead\n        ng-show="filters.length !== facets.length"\n        query="query"\n        facets="typeaheadSuggestions"\n        hide-not-found="options.defaultFacet && !filters.length"\n        on-select="addTypeaheadSuggestion(value)"\n        placeholder="{{options.placeholder}}" />\n    </div>\n\n    <div class="facetly-buttons">\n      <a href="" class="facetly-button facetly-button-success" ng-click="search()">Search</a>\n      <a class="facetly-button facetly-button-danger" href="" ng-if="filters.length" ng-click="removeAllFilters()">Remove all</a>\n    </div>\n  </div>\n\n  <p class="facetly-hint-text facetly-text-gray">Hint: You can use advanced search keywords to more easily find what you’re looking for. <a href="" ng-click="showFacets=!showFacets">What keywords can I use?</a></p>\n\n  <p class="facetly-hint-text facetly-text-danger" ng-show="errors.length">\n    Please correct the following errors before continuing:\n    <ul>\n      <li ng-repeat="error in errors" ng-bind="error"></li>\n    </ul>\n  </p>\n\n  <ul class="facetly-facets" ng-show="showFacets">\n    <li ng-repeat="facet in facets | filter:availableFacets">\n      <a class="facetly-facet" href="" title="" ng-click="addFilter(facet)" ng-bind="facet.label"></a>\n    </li>\n  </ul>\n</div>\n'),e.put("facets/hierarchy.html",'<div class="facetly-hierarchy">\n\n  <facetly-typeahead\n    allow-multiselect="allowMultiselect"\n    query="query"\n    facets="typeaheadSuggestions"\n    on-select="addTypeaheadSuggestion(value)"\n    list-max-items="listMaxItems"\n    placeholder="Start typing to filter..." />\n\n</div>\n'),e.put("facets/select.html",'<div class="facetly-select">\n\n  <facetly-typeahead\n    allow-multiselect="allowMultiselect"\n    query="query"\n    value="value"\n    facets="options"\n    on-select="addTypeaheadSuggestion(value)"\n    list-max-items="listMaxItems"\n    placeholder="Start typing to filter..." />\n\n</div>\n'),e.put("filter/filter.html",'<li ng-class="{\'facetly-validation-error\': filter.isValid === false}">\n  <span class="facetly-facet">\n    <a class="facetly-icon facetly-text-danger" href="" tabindex="-1" ng-click="remove()"> &times; </a>\n    {{::filter.label}}:\n  </span>\n  <span class="facetly-value" ng-switch="filter.type">\n    <facetly-select ng-switch-when="select" options="filter.options" allow-multiselect="filter.multiselect" on-select-change="updateFilterValue(value)" list-max-items="listMaxItems" value="filter.value" />\n    <facetly-hierarchy ng-switch-when="hierarchy" options="filter.options" allow-multiselect="filter.multiselect" on-select-change="updateFilterValue(value)" list-max-items="listMaxItems" value="filter.value" />\n    <input ng-switch-default type="text" class="facetly-form-control" ng-model="filter.value" />\n  </span>\n</li>\n'),e.put("typeahead/typeahead.html",'<div class="facetly-typeahead">\n  <div class="facetly-typeahead-selected" ng-show="showSelected">\n    <span ng-repeat="value in selected">\n      <a class="facetly-icon facetly-text-danger" href="" tabindex="-1" ng-click="removeSelected(value)">&times;</a> {{value.title}}\n    </span>\n  </div>\n\n  <input\n    class="facetly-form-control"\n    type="text"\n    ng-model="query"\n    ng-focus="showSuggestions=true"\n    ng-click="showSuggestions=true"\n    placeholder="{{placeholder}}">\n\n  <div class="facetly-typeahead-suggestions" ng-if="showSuggestions && (!listMaxItems || (listMaxItems && listMaxItems >= suggestions.length))">\n    <ul>\n      <li class="facetly-suggestion"\n        ng-class="{\'last\': $last, \'selected\': $index === selectedIndex}"\n        ng-repeat="suggestion in suggestions track by $index"\n        ng-mouseenter="updateSelectedIndex(suggestion)">\n          <a href="" ng-click="addSuggested(suggestion)">\n            <span ng-if="allowMultiselect && isSelected(suggestion)">&#10004;</span>\n            <span ng-bind-html="suggestion.title | facetlyHighlight:query"></span>\n          </a>\n      </li>\n      <li class="last" ng-show="query.length && !suggestions.length && !hideNotFound">\n        <span>No match found...</span>\n      </li>\n    </ul>\n  </div>\n</div>\n')}]);